---
title: V1.0.6 - Student Financial Status Master & Turnstile Reliability
description: Implementation of a centralized financial status column in users_alunos and turnstile logic audit.
status: pending
---

# V1.0.6 - Student Financial Status Master

## ðŸŽ¯ Goals
1.  **Status Master**: Add `status_financeiro` column to `users_alunos` to centralize access logic.
2.  **Turnstile Reliability**: Audit and refine the "Motor" logic to prevent unauthorized access.
3.  **Efficiency**: Reduce query load on the reception PC by listening to a single column change.
4.  **Deployment**: Bump version to 1.0.6 and deploy.

## ðŸ› ï¸ Tasks

### Phase 1: Database (SQL Migration)
- [ ] Create migration `20260222_student_financial_status_master.sql`.
- [ ] Add `status_financeiro` (TEXT, default 'pending') to `users_alunos`.
- [ ] Implement `fn_calculate_student_financial_status(student_id UUID)` in Postgres.
    - Logic: Months since entry vs total payments.
    - Status: 'paid', 'pending', 'overdue'.
- [ ] Add trigger on `financial_transactions` (after insert/update/delete) to refresh student status.
- [ ] Add trigger on `users_alunos` (after update of `payment_due` or `created_at`) to refresh status.

### Phase 2: Flutter Backend (Services)
- [ ] Update `FinancialService`:
    - Adapt to read the new `status_financeiro` column.
    - Add a `refreshStudentStatus(String studentId)` RPC call if needed for force-refresh.
- [ ] Update `ControlIdService`:
    - Simplify `syncStudentRealtime` to listen only to the `status_financeiro` column change in the WebSocket payload.
    - Ensure `addUser` and `removeUser` are called consistently.

### Phase 3: Flutter UI (Motor & Tools)
- [ ] Audit `MotorCatracaScreen.dart`:
    - Ensure it acts as a reliable bridge.
    - Improve log clarity for the client.
- [ ] Audit `AdminDashboard.dart`:
    - Verify the "Silent Sync" on init.

### Phase 4: Versioning & Release
- [ ] Update `pubspec.yaml` to `1.0.6+1`.
- [ ] Update `lib/config/app_version.dart` to `1.0.6`.
- [ ] Commit with tag `v1.0.6`.
- [ ] Firebase Deploy.

## ðŸ§ª Verification Plan
1.  **DB Check**: Insert a transaction for an overdue student -> Verify `status_financeiro` changes to 'paid'.
2.  **Motor Check**: Change student due date to past -> Verify Motor logs 'ðŸš« Alerta: Aluno bloqueado'.
3.  **Remote Check**: Perform payment from a different device -> Verify reception PC (Motor) reacts instantly.
